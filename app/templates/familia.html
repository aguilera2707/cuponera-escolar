<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Perfil de Familia</title>
</head>
<body>
    <form action="{{ url_for('generar_qr_staff', familia_id=familia.id) }}" method="POST">
    <button type="submit">Actualizar QR para uso del staff</button>
    </form>
    <h1>Familia: {{ familia.nombre }}</h1>
    <p>Puntos actuales: {{ familia.puntos }}</p>

    <h2>Historial de transacciones</h2>
        <p>
    <a href="{{ url_for('exportar_transacciones', familia_id=familia.id) }}">
        üì• Exportar historial a Excel (CSV)
    </a>
    </p>
    <form action="{{ url_for('generar_o_regenerar_qr', familia_id=familia.id) }}" method="POST" style="margin-top: 1em;">
    <button type="submit">Generar/Actualizar c√≥digo QR</button>
</form>
    <h2>Filtrar historial</h2>
<form method="GET">
    <label for="tipo">Tipo de transacci√≥n:</label>
    <select name="tipo" id="tipo">
        <option value="">-- Todos --</option>
        <option value="suma" {% if request.args.get('tipo') == 'suma' %}selected{% endif %}>Acreditaci√≥n</option>
        <option value="canje" {% if request.args.get('tipo') == 'canje' %}selected{% endif %}>Canje</option>
    </select>

    <label for="fecha_inicio">Desde:</label>
    <input type="date" name="fecha_inicio" value="{{ request.args.get('fecha_inicio', '') }}">

    <label for="fecha_fin">Hasta:</label>
    <input type="date" name="fecha_fin" value="{{ request.args.get('fecha_fin', '') }}">

    <button type="submit">Filtrar</button>
</form>
{% if transacciones %}
<table border="1">
    <tr>
        <th>Fecha</th>
        <th>Tipo</th>
        <th>Puntos</th>
        <th>Descripci√≥n</th>
    </tr>
    {% for transaccion in transacciones %}
    <tr>
        <td>{{ transaccion.fecha.strftime('%Y-%m-%d %H:%M') }}</td>
        <td>
            {% if transaccion.tipo == 'suma' %}
                Acreditaci√≥n
            {% elif transaccion.tipo == 'canje' %}
                Canje
            {% else %}
                {{ transaccion.tipo }}
            {% endif %}
        </td>
        <td>{{ transaccion.puntos }}</td>
        <td>{{ transaccion.descripcion or 'Sin descripci√≥n' }}</td>
    </tr>
    {% endfor %}
</table>
{% else %}
    <p><em>No hay transacciones que coincidan con los filtros seleccionados.</em></p>
{% endif %}
    <h2>Registrar transacci√≥n</h2>
<form id="transaccionForm">
    <select name="tipo" required>
        <option value="suma">Suma</option>
        <option value="canje">Canje</option>
    </select>
    <input type="number" name="puntos" required min="1" placeholder="Cantidad de puntos">
    <input type="text" name="descripcion" placeholder="Descripci√≥n">
    <button type="submit">Registrar</button>
</form>

<div id="mensaje-transaccion" style="margin-top:10px; font-weight:bold;"></div>

<p><a href="{{ url_for('lista_familias') }}">‚Üê Volver al listado de familias</a></p>

<h3>C√≥digo QR:</h3>
<img src="{{ url_for('static', filename='qr/familia_' ~ familia.id ~ '.png') }}" alt="QR de la familia">

<script>
document.getElementById("transaccionForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = {
        tipo: formData.get("tipo"),
        puntos: formData.get("puntos"),
        descripcion: formData.get("descripcion")
    };

    fetch(`/familia/{{ familia.id }}/transaccion`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
    })
    .then(resp => resp.json())
    .then(resp => {
        const div = document.getElementById("mensaje-transaccion");
        div.innerText = resp.mensaje || resp.error;
        div.style.color = resp.mensaje ? "green" : "red";
        setTimeout(() => { div.innerText = ""; }, 4000);
        if (resp.mensaje) location.reload();  // recarga si fue exitoso
    })
    .catch(err => {
        console.error("Error:", err);
    });
});
</script>
</body>
</html>